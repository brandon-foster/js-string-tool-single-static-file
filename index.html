<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>string functions</title>
    </head>
    <body>
        <select id="select"></select>
        <div id="paramInputsContainer"></div>
        <textarea id="input" rows="10" cols="200"></textarea>
        <textarea id="output" rows="20" cols="200"></textarea>
        <script type="text/javascript">
            function element(id) {
                return document.getElementById(id);
            }
            function paramsFrom(fn) {
                const fnString = fn.toString();
                const start = fnString.indexOf('(') + 1;
                const end = fnString.indexOf(')');
                let result = fnString.substring(start, end);
                result = result.replace(/\s+/g, '');
                result = result.split(',');
                return result;
            }
            function countParams(fn) {
                const params = paramsFrom(fn);
                return params.length;
            }
            function log(str) {
                console.log(str);
            }
            const operations = [
                function javaOpts(str) {
                    return str.replaceAll(' ', '\n');
                },
                function replaceWithNewLine(str, from) {
                    if (from === '') {
                        return str;
                    }
                    return str.replaceAll(from, '\n');
                },
                function jsonParseAndStringify(str) {
                    try {
                        const obj = JSON.parse(str);
                        return JSON.stringify(obj, null, 4);
                    }
                    catch (e) {
                        return null;
                    }
                },
                function replace(str, from, to) {
                    if (to === '') {
                        return str;
                    }
                    return str.replaceAll(from, to);
                },
                function trim(str) {
                    return str.trim();
                },
                function upper(str) {
                    return str.toUpperCase();
                },
                function lower(str) {
                    return str.toLowerCase();
                },
            ];
            function makeOperationMachine() {
                let opIndex = 0;
                let argc = 1;
                return {
                    getMode: function() {
                        return opIndex;
                    },
                    setMode: function(num) {
                        opIndex = num;
                        argc = countParams(this.getOpFn());
                    },
                    getArgc: function() {
                        return argc;
                    },
                    getOpFn: function() {
                        return operations[opIndex];
                    },
                    getOperations: function() {
                        return operations;
                    },
                };
            };
            function makeUi(config) {
                const { inputTextarea, outputTextarea, select, paramInputsManager, stringMachine } = config;
                function setupListeners(config) {
                    function onPaste(e) {
                        const clipboardText = e.clipboardData.getData('text/plain');
                        perform(clipboardText);
                    }
                    inputTextarea.addEventListener('paste', onPaste);
                    function onChangeSelect() {
                        const opIndex = parseInt(select.value);
                        stringMachine.setMode(opIndex);
                        const opFn = stringMachine.getOpFn(opIndex);
                        paramInputsManager.showParamInputsFor(opFn.name);
                        perform();
                    }
                    select.addEventListener('change', onChangeSelect);
                    function onKeyup() {
                        perform();
                    }
                    inputTextarea.addEventListener('keyup', onKeyup);
                    outputTextarea.addEventListener('keyup', onKeyup);
                    const fnObjs = paramInputsManager.getFnObjs();
                    for (const prop in fnObjs) {
                        const inputs = fnObjs[prop].inputs;
                        for (const input of inputs) {
                            input.addEventListener('keyup', onKeyup);
                        }
                    }
                }
                function perform(input = inputTextarea.value) {
                    const opFn = stringMachine.getOpFn();
                    const paramValues = paramInputsManager.getParamValues();
                    let output = opFn(input, ...paramValues);
                    if (output === null) {
                        output = 'cannot parse as JSON';
                    }
                    outputTextarea.value = output;
                }
                function populateSelectOptions() {
                    function makeOptionElement(value, text) {
                        const optionElement = document.createElement('option');
                        optionElement.text = text;
                        optionElement.value = value;
                        return optionElement;
                    }
                    const operations = stringMachine.getOperations();
                    for (let i = 0; i < operations.length; i++) {
                        select.add(makeOptionElement(i, operations[i].name));
                    }
                }
                function makeArgInputElems(paramInputsManager) {
                    const fnObjs = paramInputsManager.getFnObjs();
                    for (const prop in fnObjs) {
                        const paramInputsContainerElem = element('paramInputsContainer');
                        const inputs = fnObjs[prop].inputs;
                        for (let i = 0; i < inputs.length; i++) {
                            paramInputsContainerElem.append(inputs[i]);
                        }
                    }
                }
                makeArgInputElems(paramInputsManager);
                setupListeners(config);
                populateSelectOptions();
                return {
                    getInputElem: function() {
                        return inputTextarea;
                    },
                };
            };
            window.onload = function() {
                const paramInputsManager = (function makeParamInputsManager(ops) {
                    let currentlyVisibleParamInputsFnName = null;
                    function makeFnObj(fn, params, inputs) {
                        return {
                            fn: fn,
                            params: params,
                            inputs: inputs,
                        };
                    }
                    const fnObjs = {};
                    for (let i = 0; i < ops.length; i++) {
                        const fn = ops[i];
                        const params = paramsFrom(fn);
                        const inputs = [];
                        for (let j = 0; j < params.length; j++) {
                            if (j != 0) {
                                const input = document.createElement('input');
                                input.id = `${fn.name}-${params[j]}`;
                                input.placeholder = params[j];
                                input.style.display = 'none';
                                inputs.push(input);
                            }
                        }
                        fnObjs[fn.name] = makeFnObj(fn, params, inputs);
                    }
                    function getFnObjs() {
                        return fnObjs;
                    }
                    function showParamInputsFor(fnName) {
                        if (null != currentlyVisibleParamInputsFnName) {
                            const currInputs = fnObjs[currentlyVisibleParamInputsFnName].inputs;
                            for (let i = 0; i < currInputs.length; i++) {
                                currInputs[i].style.display = 'none';
                            }
                        }
                        const inputs = fnObjs[fnName].inputs;
                        for (let i = 0; i < inputs.length; i++) {
                            inputs[i].style.display = 'inline';
                        }
                        currentlyVisibleParamInputsFnName = fnName;
                    }
                    function getParamValues() {
                        const arr = [];
                        if (null != currentlyVisibleParamInputsFnName) {
                            const fnObj = fnObjs[currentlyVisibleParamInputsFnName];
                            const inputs = fnObj.inputs;
                            for (let i = 0; i < inputs.length; i++) {
                                arr.push(inputs[i].value);
                            }
                        }
                        return arr;
                    }
                    return {
                        getFnObjs: getFnObjs,
                        showParamInputsFor: showParamInputsFor,
                        getParamValues: getParamValues,
                    };
                }(operations));
                const ui = makeUi({
                    inputTextarea: element('input'),
                    outputTextarea: element('output'),
                    select: element('select'),
                    paramInputsManager: paramInputsManager,
                    stringMachine: makeOperationMachine(operations),
                }).getInputElem().focus();
            }
        </script>
    </body>
</html>
